# Спецификация CSV для «Загрузка конверсий по ссылке» (Яндекс.Директ)

Источник: [Яндекс.Директ — Центр конверсий](https://yandex.ru/support/direct/statistics/conversions.html), [Формат даты Метрики](https://yandex.ru/dev/metrika/ru/data-import/date).

---

## Общие требования

- **Формат:** CSV
- **Разделитель колонок:** точка с запятой (`;`)
- **Кодировка:** UTF-8
- **Размер файла:** не более 1 ГБ

---

## Колонки по порядку (как в примере Директа)

### 1. create_date_time — **обязательное**

Дата и время конверсии в **часовом поясе счётчика Метрики**.

- **Формат:** дата и время — `dd.MM.yyyy HH:mm:ss` (например `21.04.2020 11:59:21`).
- Допускается только дата — тогда Директ/Метрика подставят время 23:59:59.
- **Ограничения:** не старше 113 дней («'create_date_time' is older than 113 days»), не в будущем («'create_date_time' is from the future»).
- Другие допустимые форматы по справке Метрики: `dd.MM.yy HH:mm`, `yyyy-MM-dd HH:mm:ss` и др.

### 2. id — необязательное

Идентификатор заказа в вашей CRM (произвольное значение). Нужен для обновления статуса (например с IN_PROGRESS на PAID) и перепривязки заказа к клиенту.

### 3. client_uniq_id — необязательное

Идентификатор клиента в CRM. Помогает склеивать заказы одного клиента между выгрузками.

### 4. client_ids — **обязательно хотя бы одно из полей 4–8**

Список **ClientID** Метрики (числовой идентификатор посетителя счётчика). Один или несколько через запятую. Лучший вариант для атрибуции конверсий к визитам с сайта.

- Для заявок с сайта передаём один ClientID (из `ym_client_id`).
- Для заявок только из Telegram не заполняем — используем **phones**.

### 5. emails — необязательное (но один из идентификаторов обязателен)

Список email. Латиница, символ `@`, строчные буквы. Пример: `mail@yandex.ru`. Несколько значений — в кавычках, через запятую без пробелов: `"mail1@example.com,mail2@example.com"`.

### 6. phones — необязательное (но один из идентификаторов обязателен)

Список телефонов. **Числовая строка, код страны, без пробелов и дополнительных символов.** Пример: `79995551111`. Слишком короткие номера приводят к ошибке «Invalid 'phones' identifier» — в выгрузке используем только номера длиной не менее 10 цифр (с кодом страны). Несколько — в кавычках, через запятую без пробелов: `"79876543210,79991234567"`.

### 7. emails_md5 — необязательное

Список MD5-хешей от email (в том же формате, что и для emails). Проверка: `mail@yandex.ru` → `3c56ff8fef0f6c65b36b2d25720fe276`.

### 8. phones_md5 — необязательное

Список MD5-хешей от телефонов (только цифры, код страны). Проверка: `79995551111` → `f09f2c3d48f31e2a802944ade2e5aec5`.

### 9. order_status — необязательное (по умолчанию PAID)

В интерфейсе Директа («Статус конверсии в файле») допустимы **только 4 значения** (большими буквами):

- **IN_PROGRESS** — заказ создан, но не оплачен
- **PAID** — оплачен
- **CANCELLED** — отменён
- **SPAM** — спам

Другие значения в файле использовать нельзя. В нашем коде статусы заявок (trial_scheduled, enrolled, paid и т.д.) маппятся в эти четыре.

### 10. revenue — необязательное

Доход по заказу. **Десятичная дробь, разделитель — точка.** Пример: `1508.50`. Неотрицательное, не более 9223372036854.

### 11. cost — необязательное

Себестоимость. **Десятичная дробь, разделитель — точка.** Используется для расчёта прибыли (Выручка − Себестоимость).

---

## Итог по обязательности

- Обязательны: **create_date_time** и **хотя бы один идентификатор** (client_ids, emails, phones, emails_md5 или phones_md5).
- Остальные колонки можно не заполнять (пустое значение между `;`).

---

## Порядок колонок в файле (рекомендуемый)

Как в официальном примере и в приложенном simple_orders_conv:

`create_date_time`; `id`; `client_uniq_id`; `client_ids`; `emails`; `phones`; `emails_md5`; `phones_md5`; `order_status`; `revenue`; `cost`

Колонку COMMENT из примера можно не включать (в справке указано, что она игнорируется).
