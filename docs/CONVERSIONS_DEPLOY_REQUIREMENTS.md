# Что нужно для работы конверсий (Метрика + Директ)

## ⛔ БЕЗ ЭТОГО НИЧЕГО НЕ РАБОТАЕТ

Проверь **до** и **после** деплоя. Если чего-то нет — конверсии молча не будут работать.

| № | Что | Где |
|---|-----|-----|
| 1 | **DATABASE_URL** (строка подключения к PostgreSQL с таблицей `leads`) | Переменные окружения функций **leads** и **conversions-csv** |
| 2 | **YANDEX_METRIKA_TOKEN** (OAuth-токен владельца счётчика Метрики) | Переменная окружения функции **metrika-conversion** |
| 3 | Цели в Метрике: `trial_scheduled`, `trial_completed`, `enrolled`, `paid` (тип «JavaScript-событие») | Счётчик 104854671 → Настройка → Цели |
| 4 | Источник «Файл по ссылке» с URL функции conversions-csv + выбор счётчика Метрики | Директ → Конверсии → Добавить источник |

Нет пункта 1 — заявки не сохраняются, CSV по ссылке падает. Нет пункта 2 — конверсии не уходят в Метрику. Нет 3 — Метрика отклонит загрузку. Нет 4 — Директ не подтянет файл.

**Кнопки в Telegram:** чтобы нажатия по заявкам работали (и статус уходил в leads → Метрику → CSV), у бота должен быть настроен **webhook** на URL функции **telegram-bot**. Без этого Telegram не шлёт в бот события нажатий. У функции **telegram-bot** переменная **LEADS_API_URL** не обязательна (есть дефолт), но если твой leads на другом URL — задай её.

---

## 1. База данных (для leads и conversions-csv)

Обе функции читают/пишут заявки из таблицы **leads** в той же БД, что и остальной проект.

| Функция           | Нужна переменная | Обязательно |
|-------------------|------------------|-------------|
| **leads**         | `DATABASE_URL`   | Да          |
| **conversions-csv** | `DATABASE_URL` | Да          |

- **DATABASE_URL** — строка подключения PostgreSQL (как у других функций: gallery, auth и т.д.).
- В Cloud-функциях **leads** и **conversions-csv** в настройках должны быть прописаны **переменные окружения** (или секреты): `DATABASE_URL` = твоя строка подключения.
- БД должна быть одна и та же: в ней есть таблица **leads** и при необходимости схема `t_p90119217_django_layout_develo` (в коде выставляется `search_path`).

Если **DATABASE_URL** не задан или указана другая БД — **conversions-csv** при запросе по ссылке упадёт с ошибкой, файл для Директа не отдастся. **leads** не сможет ни сохранять заявки, ни вызывать Метрику.

---

## 2. Токен Метрики (для metrika-conversion)

| Функция              | Нужна переменная       | Обязательно |
|----------------------|------------------------|-------------|
| **metrika-conversion** | `YANDEX_METRIKA_TOKEN` | Да          |

- **YANDEX_METRIKA_TOKEN** — OAuth-токен владельца счётчика Метрики (как получить — см. в чате или в справке по Метрике).
- Прописывается в настройках облачной функции **metrika-conversion** (переменная или секрет).

Без токена загрузка офлайн-конверсий в Метрику по API не выполнится.

---

## 3. Краткий чеклист после деплоя

- [ ] **leads**: задан `DATABASE_URL` (та же БД, что и у сайта/других функций).
- [ ] **conversions-csv**: задан `DATABASE_URL` (та же БД, таблица **leads**).
- [ ] **metrika-conversion**: задан `YANDEX_METRIKA_TOKEN`.
- [ ] В счётчике Метрики созданы цели с идентификаторами: `trial_scheduled`, `trial_completed`, `enrolled`, `paid`.
- [ ] В Директе добавлен источник «Файл по ссылке» с URL функции **conversions-csv**.

Если что-то из этого не сделано — конверсии не заработают, даже если код задеплоен.
